{% extends "spotter_base.html" %}

{% block morehead %}
<script>

var count = 0;
var week = 0;

function delete_day(key) {
     $("tr[id*=\"head_"+ key +"\"]").remove();
     $("tr[id*=\"day_"+ key +"\"]").remove();
     $("tr[id*=\"row_"+ key +"\"]").remove(); 
     $("tr[id*=\"foot_"+ key +"\"]").remove(); 
     delete_exercise("row_"+ key);
}
function save_workoutday(exercise, lift, display, set1, set2, set3, set4, set5, set6) { 
     $.ajax({
        url: 'workoutplan_day-ajax',
        type: 'POST',
        data: { mode: 'save_workoutplan_day',
        exercise: exercise, lift: lift, display: display, set1: set1, set2: set2, set3: set3, set4: set4, set5: set5, set6: set6 },
      })
}
function delete_exercise(exercise) { 
     $.ajax({
        url: 'workoutplan_day-ajax',
        type: 'POST',
        data: {mode: 'delete_workoutplan_day', key: exercise},
      })
}
function cancel_row(location, exercise) {
    var tr = $(location).closest('tr');
        tr.css("background-color","#FFFFFF");
        tr.fadeOut(400, function(){
            tr.remove();
        });
        delete_exercise(exercise);
        $("tr[id*=\"foot_"+ exercise +"\"]").remove(); 
}

function save_day(inuse, location, exercise, count, option) {

// save day entry, structure:
//       <tr id="day_64_220"><td><b>Monday</b></td>
//          
//          <td><a onClick='if(confirm("Delete entire day?")) delete_day(row_64_220);'><small>(delete)</small></a></td>
//          
//          <td><a onclick="insert_row('#head_64_220', '64_220');">add Exercise</a></td>
//
//       <tr id="head_64_220" style="height:5px;"></tr>

    var tr = $(location).closest('tr');

        cancel_row(location);

        save_workoutday(exercise, $("#days_"+ count +" :selected").val());

        head = "<tr id='day_"+ exercise +"_"+ count +"'>"
         day = "<td><b>"+$("#days_"+ count +" :selected").text()+"</b></td>"
         del = "<td><a onClick='if(confirm(\"Delete entire day?\")) delete_day(\""+ exercise +"_"+ count +"\");'><small>(delete)</small></a></td>"
      insert = "<td><a onclick='insert_row(\"#head_"+ exercise +"_"+ count +"\", \""+ exercise +"_"+ count +"\");'>add Exercise</a></td></tr>";
        foot = "<tr id='head_"+ exercise +"_"+ count+"' style='height:5px;'></tr>";

        tr.after(head+day+del+insert+foot);

}

function save_row(inuse, location, exercise, count, option) {

// save row, structure:
//       <tr id="row_64_220_217"> <td id="controls_64_220_217">            
//          <a onclick="cancel_row(this, '64_220_217');"><small>(del)</small></a>
//          <a onclick="edit_row(0, '64_220_217', 'Wide-Grip BTN Press', '5x3 + 1x10',  '3', '3', '3', '3', '3', '10', '', '', '', '', '', '' );"><small>(edit)</small></a>
//          </td>
//          <td align="left" id="row_64_220_217_lift"> Wide-Grip BTN Press </td>
//          <td align="left" id="row_64_220_217_display"> 5x3 + 1x10 </td>
//            
//             <td align="left" 
//              id="row_64_220_217_set_1"> 3 </td>
// ...          
//          </tr>

    var tr = $(location).closest('tr');

    if (option===0) {  // inserted row
        cancel_row(location);

        save_workoutday(exercise, $("#lifts_"+ count +" :selected").val(), $("#sets_display"+ count).val(), $("#set1_"+ count).val(), $("#set2_"+ count).val(), $("#set3_"+ count).val(), $("#set4_"+ count).val(), $("#set5_"+ count).val(), $("#set6_"+ count).val());

           head = "<tr id='row_"+ exercise +"'><td id='controls_"+ exercise +"'>"
         cancel = "<a onclick='cancel_row(this, \""+ exercise +"\");'><small>(del)</small></a>"
           edit = "<a onclick='edit_row("+ inuse +", \""+ exercise +"\", \""+ $("#lifts_"+ count +" :selected").text() + "\", \""+ $("#sets_display"+ count).val() +"\", 0"+$("#set1_"+ count).val()+", 0"+$("#set2_"+ count).val()+", 0"+$("#set3_"+ count).val()+", 0"+$("#set4_"+ count).val()+", 0"+$("#set5_"+ count).val()+", 0"+$("#set6_"+ count).val()+");'><small>(edit)</small></a></td>"
       controls = head+cancel+edit

        lift    = "<td id='row_"+ exercise +"_lift' align='left'>"+$("#lifts_"+ count +" :selected").text()+"</td>";
        display = "<td id='row_"+ exercise +"_display' align='left'>"+$("#sets_display"+ count).val()+"</td>";
        set1    = "<td id='row_"+ exercise +"_set_1' align='left'>"+$("#set1_"+ count).val()+"</td>";
        set2    = "<td id='row_"+ exercise +"_set_2' align='left'>"+$("#set2_"+ count).val()+"</td>";
        set3    = "<td id='row_"+ exercise +"_set_3' align='left'>"+$("#set3_"+ count).val()+"</td>";
        set4    = "<td id='row_"+ exercise +"_set_4' align='left'>"+$("#set4_"+ count).val()+"</td>";
        set5    = "<td id='row_"+ exercise +"_set_5' align='left'>"+$("#set5_"+ count).val()+"</td>";
        set6    = "<td id='row_"+ exercise +"_set_6' align='left'>"+$("#set6_"+ count).val()+"</td>";
        foot    = "<tr id='foot_"+ exercise +"' style='height:1px;'></tr>";

        tr.after(controls+lift+display+set1+set2+set3+set4+set5+set6);
    }

    if (option===1) {  // edited row

        $('#row_'+exercise+'_lift').replaceWith('<td id="row_'+ exercise +'_lift" align="left">'+$('#lifts_'+ exercise +' :selected').text()+'</td>');
        $('#row_'+exercise+'_display').replaceWith('<td id="row_'+ exercise +'_display">'+$('#row_'+ exercise+'_display').val()+'</td>');
        $('#row_'+exercise+'_set_1').replaceWith('<td id="row_'+ exercise +'_set_1">'+$('#row_'+exercise+'_set_1').val()+'</td>');
        $('#row_'+exercise+'_set_2').replaceWith('<td id="row_'+ exercise +'_set_2">'+$('#row_'+exercise+'_set_2').val()+'</td>');
        $('#row_'+exercise+'_set_3').replaceWith('<td id="row_'+ exercise +'_set_3">'+$('#row_'+exercise+'_set_3').val()+'</td>');
        $('#row_'+exercise+'_set_4').replaceWith('<td id="row_'+ exercise +'_set_4">'+$('#row_'+exercise+'_set_4').val()+'</td>');
        $('#row_'+exercise+'_set_5').replaceWith('<td id="row_'+ exercise +'_set_5">'+$('#row_'+exercise+'_set_5').val()+'</td>');
        $('#row_'+exercise+'_set_6').replaceWith('<td id="row_'+ exercise +'_set_6">'+$('#row_'+exercise+'_set_6').val()+'</td>');

        var lift = $('#row_'+exercise+'_lift').text();
     var display = $('#row_'+exercise+'_display').text();
        var set1 = $('#row_'+exercise+'_set_1').text(); 
        var set2 = $('#row_'+exercise+'_set_2').text();
        var set3 = $('#row_'+exercise+'_set_3').text(); 
        var set4 = $('#row_'+exercise+'_set_4').text();
        var set5 = $('#row_'+exercise+'_set_5').text(); 
        var set6 = $('#row_'+exercise+'_set_6').text();

        if (set1.length < 1) { set1='0'; } if (set2.length < 1) { set2='0'; } if (set3.length < 1) { set3='0'; }
        if (set4.length < 1) { set4='0'; } if (set5.length < 1) { set5='0'; } if (set6.length < 1) { set6='0'; }

        $('#controls_'+exercise).replaceWith("<td id='controls_"+ exercise +"'><a onclick='cancel_row(this, \""+ exercise +"\");'><small>(del)</small></a>&nbsp;<a onclick='edit_row("+ inuse +", \""+ exercise +"\", \""+ lift +"\", \""+ display+ "\", "+ set1 +", "+ set2 +", "+ set3 +", "+ set4 +", "+ set5 +", "+ set6 +");'><small>(edit)</small></a></td>");

        save_workoutday(exercise, lift, display, set1, set2, set3, set4, set5, set6);
    }
}

function insert_week(location, exercise) {

// insert new week, call backend and refresh page:
     $.ajax({
        url: 'workoutplan_day-ajax',
        type: 'POST',
        data: { mode: 'add_week',
        exercise: exercise },
     })

}

function insert_day(location, exercise) {

// insert new day, structure:
//       <tr id="day_64_1"><td><b>Monday</b></td></tr>
//          
//          <td><a onClick='cancel_row(this);'><small>(cancel)</small></a></td>          
//          <td><a onclick="save_day(...);">(save)</a></td>
//
//       <tr id="head_64_1" style="height:5px;"></tr>

    count++; c = count.toString();

    head = "<tr id='day_"+ exercise +"_"+ c +"'>";
  cancel = "<td><a onclick='cancel_row(this);'><small>(cancel)</small></a>&nbsp;";
    save = "<a onclick='save_day(0, this, \""+ exercise +"_"+ c +"\", " + c + ", 0);'><small>(save)</small></a></td>";
     day = "<td align='left'><select id='days_"+ c +"' ><option value='M'>Monday</option><option value='T'>Tuesday</option><option value='W'>Wednesday</option><option value='H'>Thursday</option><option value='F'>Friday</option><option value='S'>Saturday</option><option value='U'>Sunday</option></select></td></td></tr>";
     gap = "<tr id='head_"+ exercise +"_"+ c +"' style='height:5px;'></tr>";
    foot = "<tr id='foot_"+ exercise +"_"+ c +"' style='height:1px;'></tr>";

    $(location).after(head+cancel+save+day+gap+foot);
}

function insert_row(location, exercise) {

// insert new row, structure:
//       <tr id="row_64_220_1"> <td id="controls_64_220_1">
//          <a onclick="cancel_row(this, '64_220_1');"><small>(del)</small></a>
//          <a onclick="save_row(0, '64_220_1', 'Wide-Grip BTN Press', '5x3 + 1x10',  '3', '3', '3', '3', '3', '10', '', '', '', '', '', '' );"><small>(edit)</small></a>
//          </td>
//          <td align="left" id="row_64_220_1_lift"> Wide-Grip BTN Press </td>
//          <td align="left" id="row_64_220_1_display"> 5x3 + 1x10 </td>
//            
//             <td align="left"
//              id="row_64_220_1_set_1"> 3 </td>
// ...
//          </tr>

    count++; c = count.toString();

    head = "<tr id='row_"+ exercise +"_"+ count +"'>";
  cancel = "<td><a onclick='cancel_row(this, \""+ exercise +"_"+ c +"\");'><small>(cancel)</small></a>&nbsp";
    save = "<a onclick='save_row(0, this, \""+ exercise +"_"+ c +"\", " + c + ", 0);'><small>(save)</small></a></td>";
   lifts = "<td align='left'><select id='lifts_"+ c +"' >{% for l in lifts|dictsort:"name" %}<option value='{{l.id}}'>{{l.name}}</option>{% endfor %}</select></td>";
 display = "<td align='left'><input type='text' id='sets_display"+ c +"' style='width:100px;' value='3x10'/></td>";
    set1 = "<td align='left'><input type='text' id='set1_"+ c +"' style='width:20px;' placeholder='Set'/>";
    set2 = "<td align='left'><input type='text' id='set2_"+ c +"' style='width:20px;' placeholder='Set'/>";
    set3 = "<td align='left'><input type='text' id='set3_"+ c +"' style='width:20px;' placeholder='Set'/>";
    set4 = "<td align='left'><input type='text' id='set4_"+ c +"' style='width:20px;' placeholder='Set'/>";
    set5 = "<td align='left'><input type='text' id='set5_"+ c +"' style='width:20px;' placeholder='Set'/>";
    set6 = "<td align='left'><input type='text' id='set6_"+ c +"' style='width:20px;' placeholder='Set'/></td></tr>";
    foot = "<tr id='foot_"+ exercise +"_"+ count +"' style='height:1px;'></tr>";
    $(location).after(head+cancel+save+lifts+display+set1+set2+set3+set4+set5+set6+foot);
}

function edit_row(inuse, exercise, lift, display, set1, set2, set3, set4, set5, set6) {  
 
    // edit row by making elements input type
    $('#row_'+exercise+'_lift').replaceWith("<td id='row_"+ exercise +"_lift' align='left'><select id='lifts_"+ exercise +"' align='left'>{% for l in lifts|dictsort:"name" %}<option value='{{l.id}}'>{{l.name}}</option>{% endfor %}</select></td>");
    $('#row_'+exercise+'_display').replaceWith("<td align='left'><input id='row_"+ exercise +"_display' type='text' style='width:100px;' value='"+ display +"'/></td>");
    $('#row_'+exercise+'_set_1').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_1' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_1').text() +"'/></td>");
    $('#row_'+exercise+'_set_2').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_2' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_2').text() +"'/></td>");
    $('#row_'+exercise+'_set_3').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_3' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_3').text() +"'/></td>");
    $('#row_'+exercise+'_set_4').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_4' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_4').text() +"'/></td>");
    $('#row_'+exercise+'_set_5').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_5' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_5').text() +"'/></td>");
    $('#row_'+exercise+'_set_6').replaceWith("<td align='left'><input id='row_"+ exercise +"_set_6' type='text' style='width:30px;' value='"+ $('#row_'+exercise+'_set_6').text() +"'/></td>");

    if (set1.length < 1) { set1='0'; } if (set2.length < 1) { set2='0'; } if (set3.length < 1) { set3='0'; }
    if (set4.length < 1) { set4='0'; } if (set5.length < 1) { set5='0'; } if (set6.length < 1) { set6='0'; }

    $('#controls_'+exercise).replaceWith("<td id='controls_"+exercise+"'><a onclick='cancel_edit("+ inuse +", \""+exercise+"\", \""+lift+"\", \""+display+"\", "+set1+", "+set2+", "+set3+", "+set4+", "+set5+", "+set6+");'><small>(cancel)</small></a>&nbsp;<a onclick='save_row("+ inuse +", this, \""+ exercise +"\",0 ,1);'><small>(save)</small></a></td>");

    var lifts = document.getElementById('lifts_'+ exercise);   // set lifts select
    for (var i = 0; i < lifts.options.length; i++) {
        if (lifts.options[i].text === lift) {
            lifts.selectedIndex = i;
            break;
        }
    }
}

function cancel_edit(inuse, exercise, lift, display, set1, set2, set3, set4, set5, set6) {   
    // cancel edit by reverting to .a types with initial values

    $('#row_'+exercise+'_lift').replaceWith('<td id="row_'+ exercise +'_lift" align="left">'+lift+'</td>');
    $('#row_'+exercise+'_display').replaceWith('<td id="row_'+ exercise +'_display" align="left">'+display+'</td>');
    $('#row_'+exercise+'_set_1').replaceWith('<td id="row_'+ exercise +'_set_1" align="left">'+set1+'</td>');
    $('#row_'+exercise+'_set_2').replaceWith('<td id="row_'+ exercise +'_set_2" align="left">'+set2+'</td>');
    $('#row_'+exercise+'_set_3').replaceWith('<td id="row_'+ exercise +'_set_3" align="left">'+set3+'</td>');
    $('#row_'+exercise+'_set_4').replaceWith('<td id="row_'+ exercise +'_set_4" align="left">'+set4+'</td>');
    $('#row_'+exercise+'_set_5').replaceWith('<td id="row_'+ exercise +'_set_5" align="left">'+set5+'</td>');
    $('#row_'+exercise+'_set_6').replaceWith('<td id="row_'+ exercise +'_set_6" align="left">'+set6+'</td>');
 
    if (set1.length < 1) { set1='0'; } if (set2.length < 1) { set2='0'; } if (set3.length < 1) { set3='0'; }
    if (set4.length < 1) { set4='0'; } if (set5.length < 1) { set5='0'; } if (set6.length < 1) { set6='0'; }

    if (inuse===0) {
        $('#controls_'+exercise).replaceWith("<td id='controls_"+ exercise +"'><a onclick='cancel_row(this, \""+ exercise +"\");'><small>(del)</small></a>&nbsp;<a onclick='edit_row("+ inuse +", \""+ exercise +"\", \""+ lift +"\", \""+ display+ "\", "+ set1 +", "+ set2 +", "+ set3 +", "+ set4 +", "+ set5 +", "+ set6 +");'><small>(edit)</small></a></td>");
    } else {
        $('#controls_'+exercise).replaceWith("<td id='controls_"+ exercise +"'><small><i><span title='This exercise is in use and cannot be deleted'>(in use)</span></i></small>&nbsp;<a onclick='edit_row("+ inuse +", \""+ exercise +"\", \""+ lift +"\", \""+ display+ "\", "+ set1 +", "+ set2 +", "+ set3 +", "+ set4 +", "+ set5 +", "+ set6 +");'><small>(edit)</small></a></td>");
    }
}

</script>

{% endblock %}

{% block main %}

<header>Edit Workoutplan <b>"{{ workoutplan.name }}"</b><br></header><br>
<style>
      tr:nth-of-type(odd) {
      background-color:#D8F1D7;
    }
</style>

<!--
 # table structure
 <tr id="head_64"><td><a href="">add Week</a></td></tr>
 <tr id="day_64"><td>week#<b>1</b></td>
     <td><a onclick="insert_day('#day_64', '64');">add Day</a></td></tr>
    
       <tr id="day_64_220"><td><b>Monday</b></td>
          
          <td><a onClick='if(confirm("Delete entire day?")) $("tr[id*=\"row_64_220\"]").remove(); $("tr[id*=\"day_64_220\"]").remove(); delete_exercise("row_64_220");'><small>(delete)</small></a></td>
          
          <td><a onclick="insert_row('#head_64_220', '64_220');">add Exercise</a></td>

       <tr id="head_64_220" style="height:5px;"></tr>
          
       <tr id="row_64_220_217"> <td id="controls_64_220_217">            
          <a onclick="cancel_row(this, '64_220_217');"><small>(del)</small></a>
          <a onclick="edit_row(0, '64_220_217', 'Wide-Grip BTN Press', '5x3 + 1x10',  '3', '3', '3', '3', '3', '10', '', '', '', '', '', '' );"><small>(edit)</small></a>
          </td>
          <td align="left" id="row_64_220_217_lift"> Wide-Grip BTN Press </td>
          <td align="left" id="row_64_220_217_display"> 5x3 + 1x10 </td>
            
             <td align="left" 
              id="row_64_220_217_set_1"> 3 </td>
 ...          
          </tr>
-->

<table id='table'>

{% if not workoutplan %}
<h3>No workout plan</h3>

{% else %}

{% if not workoutplan.workoutplanweek_set.all %}
<tr id="day_1"><td align="left"><a onclick="insert_day('#day_1', '1');">add Day</a></td></tr>

{% endif %}

{% for workoutplanweek in workoutplan.workoutplanweek_set.all %}
<tr id="head_{{ workoutplanweek.pk }}">
<td><a onclick="insert_week('#head_{{ workoutplanweek.pk }}', '{{ workoutplanweek.pk }}');">add Week</a></td></tr>
<tr id="day_{{ workoutplanweek.pk }}"><td>week#<b>{{ workoutplanweek.week }}</b></td>
    <td><a onclick="insert_day('#day_{{ workoutplanweek.pk }}', '{{ workoutplanweek.pk }}');">add Day</a></td></tr>
    {% for workoutplanday in workoutplanweek.workoutplanday_set.all %}
       <tr id="day_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}"><td><b>
               {% if workoutplanday.day_of_week == 'M' %}Monday
               {% elif workoutplanday.day_of_week == 'T' %}Tuesday
               {% elif workoutplanday.day_of_week == 'W' %}Wednesday
               {% elif workoutplanday.day_of_week == 'H' %}Thursday
               {% elif workoutplanday.day_of_week == 'F' %}Friday
               {% elif workoutplanday.day_of_week == 'S' %}Saturday
               {% elif workoutplanday.day_of_week == 'U' %}Sunday
               {% endif %}
          </b></td>
          {% if workoutplanday.gymsession_set.all %}
              <td><small><i>(in use)</i></small></td> {% else %}
              <td><a onClick='if(confirm("Delete entire day?")) delete_day("{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}");'><small>(delete)</small></a></td>
          {% endif %}
          <td>
            <a onclick="insert_row('#head_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}', '{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}');">add Exercise</a>
          </td>

       <tr id="head_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}" style="height:5px;"></tr>

          {% for exercise in workoutplanday.workout.exercise_set.all %}
              <tr id="row_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}">
              <td id="controls_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}">

              {% if workoutplanday.gymsession_set.all %}<small><i><span title="This exercise is in use and cannot be deleted">(in use)</span></i></small> {% else %}
            <a onclick="cancel_row(this, '{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}');"><small>(del)</small></a>
              {% endif %}

            <a onclick="edit_row({% if workoutplanday.gymsession_set.all %}1{% else %}0{% endif %}, '{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}', '{{ exercise.lift }}', '{{ exercise.sets_display }}', {% for set in exercise.workoutset_set.all %} '{{ set.num_reps }}',{% endfor %} '', '', '', '', '', '' );"><small>(edit)</small></a>
            </td>
            <td align="left" 
             id="row_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}_lift">{{ exercise.lift }}
            </td>
            <td align="left" 
             id="row_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}_display">{{ exercise.sets_display }}
            </td>
            {% for set in exercise.workoutset_set.all %}
               <td align="left" 
                id="row_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}_set_{{ forloop.counter }}">
                {{ set.num_reps }}</td>
            {% endfor %}
         <tr id="foot_{{ workoutplanweek.pk }}_{{ workoutplanday.pk }}_{{ exercise.pk }}" style="height:1px;"></tr>

            </tr>
         {% endfor %}
     {% endfor %}

{% endfor %}
<tr id="head_1"><td align="left"><a onclick="insert_week('#head_1', '0');">add Week</a></td></tr>

</table>

{% endif %}

{% endblock %}

